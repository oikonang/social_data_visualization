<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Week 7</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="https://d3js.org/topojson.v2.min.js"></script>
  <style type="text/css">
    button{
      width: 200px;
      background-color:#f2f2f2;
      font-size:16px;
      text-align:center;
      border-radius: 5px;
      height: 40px;
      font-size: 20px;
      font-weight: bold;
    }
    .btn:hover {
        background-color: #d9d9d9;
    }
    .currentFlag {
      background-color: #8BC34A;
      border: 3px solid #388E3C;
    }

    .title {
      font-size: 30px;
      stroke: #000066;
      fill: #212121;
    }
  </style>
</head>  
<body>
  <!--Create the buttons -->
  <div class="btn-group-lg" role="group" aria-label="...">
    <button type="button" class="btn currentFlag" value="-1" alt="Prostitution Crimes Coordinates">No Clustering</button>
    <button type="button" class="btn" value="0" alt="KNN for K=2">K=2</button>
    <button type="button" class="btn" value="1" alt="KNN for K=3">K=3</button>
    <button type="button" class="btn" value="2" alt="KNN for K=4">K=4</button>
    <button type="button" class="btn" value="3" alt="KNN for K=5">K=5</button>
    <button type="button" class="btn" value="4" alt="KNN for K=6">K=6</button>
  </div>
  <!--Call the map script -->
  <script type="text/javascript">

                //Width and height
                var w = 1000;
                var h = 800;  
                var colors = ['#E64A19','#388E3C','#303F9F','#FFEB3B','#00BCD4','#FF4081','seagreen','skyblue','salmon'];
                var buttonFlag = $(".currentFlag").attr("value"); //Set default to 0 for no clustering
                var title = $(".currentFlag").attr("alt");
                var clusterClasses = ["clusters_2","clusters_3","clusters_4","clusters_5","clusters_6"];

                //Create the centroids hardcoded(didn't manage to source them from json)
                var centroids_2 = [[-122.41721258127922, 37.787394262218022], [-122.41924311718914, 37.760004216652128]]
                var centroids_3 = [[-122.41582476469686, 37.761346056903406], [-122.41709742374232, 37.787424549878409], [-122.47811474903897, 37.738906485698408]]
                var centroids_4 = [[-122.41708247002195, 37.787427118841762], [-122.41579332831969, 37.761446811162173], [-122.46632498052548, 37.718814247089576], [-122.48639782848089, 37.758572304670537]]
                var centroids_5 = [[-122.41584224261476, 37.761425698684391], [-122.41876997704011, 37.787654471039687], [-122.46632498052548, 37.718814247089576], [-122.48639782848089, 37.758572304670537], [-122.4045346858759, 37.785530686729118]]
                var centroids_6 = [[-122.4045346858759, 37.785530686729118], [-122.41599755987995, 37.761710403228989], [-122.46952143243395, 37.719173519869869], [-122.41876997704011, 37.787654471039687], [-122.48636572534035, 37.758689247617198], [-122.40540320357452, 37.727577617551638]]
                var allCentroids = [centroids_2,centroids_3,centroids_4,centroids_5,centroids_6];

                //Define projection for the bounding box
                var projection = d3.geoMercator()
                .center([-122.433701, 37.767683])
                                   .scale(250000) //zoom-in (default=1000)
                                   .translate([w / 2, h / 2]);

                //Define path generator
                var path = d3.geoPath()
                .projection(projection);

                //Create SVG element
                var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

                //Load the json coordinates and print the map
                d3.json("geo.json", function(json) {
                  svg.selectAll("path")
                  .data(json.features)
                  .enter()
                  .append("path")
                  .attr("d", path)
                  .attr("stroke", "white")
                  .attr("stroke-width", 2)
                  .attr("stroke-opacity", 0.3)
                  .style("fill", "black")
                  .style("opacity", "0.4");
                });
                
                //Load in cluster data and print the prostitution points on the map 
                d3.csv("clusters.csv", function(data) {

                  // Create crimes coordinates by default
                  svg.selectAll(".points")
                  .data(data)
                  .enter()
                  .append("circle")
                  .attr("class", "points")
                  .attr("cx", function(d) {
                   return projection([d.X, d.Y])[0];
                 })
                  .attr("cy", function(d) {
                   return projection([d.X, d.Y])[1];
                 })
                  .attr("r", 5)
                  .style("fill", colors[0])
                  .style("opacity", 0.3);

                  // Text for the title of the plot
                  svg.append("text")
                  .attr("class", "text title") 
                  .attr("transform","translate(" + w/2 + ",80)")
                  .style("text-anchor","middle")
                  .attr("font-family", "sans-serif")
                  .attr("font-size", "20px")
                  .text(title);

                  //////////////////////////////////////Create cendroiding function///////////////
                  function centroiding(clusterClass,data){
                    //Load the centroids we want for k=2
                    svg.selectAll(clusterClass)
                    .data(data)
                    .enter()
                    .append("circle")
                    .transition()
                    .duration(500)
                    .attr("class", clusterClass)
                    .attr("cx", function(d) { return projection(d)[0]; })
                    .attr("cy", function(d) { return projection(d)[1]; })
                    .attr("r", 15)
                    .attr("stroke", "white")
                    .attr("stroke-width", 3)
                    .style("fill", "black");
                  }
                  ////////////////////////////////////////////////////////////////////////////////////////////////
                  //////////////////////////////////////Create clustering function////////////////////////////////
                  function clustering(title,isPreview){
                    var currentFlag = !isPreview ? buttonFlag : previewButtonFlag;
                    var currentTitle = !isPreview ? title : previewTitle;
                    svg.selectAll(".text.title").text(currentTitle);
                    if(currentFlag==-1)
                      svg.selectAll(".points").style("fill", colors[0]);
                    else
                      svg.selectAll(".points").style("fill", function(d){return colors[d[clusterClasses[currentFlag]]]; });
                    //Remove unneeded centroids
                    for (i = 0; i < clusterClasses.length; i++) {
                        if (i == currentFlag) { continue; } //don't remove the current centroids
                        svg.selectAll("."+clusterClasses[i]).remove();
                    }

                    if(currentFlag!=-1) {
                      //Load the centroids we want for k=2
                      centroiding(clusterClasses[currentFlag], allCentroids[currentFlag]);
                    }
                  }

                  d3.selectAll(".btn").on("click", function(){                    
                    buttonFlag = $(this).attr("value");
                    title = $(this).attr("alt");
                    var isPreview = false;
                    //clustering(title,isPreview);
                    $(".btn").removeClass("currentFlag");
                    $(this).addClass("currentFlag");
                  });

                  d3.selectAll(".btn").on("mouseover", function(){                    
                    previewButtonFlag = $(this).attr("value");
                    previewTitle = $(this).attr("alt");
                    var isPreview = true;
                    if(!$(this).hasClass("currentFlag")) 
                      clustering(title,isPreview);
                  });

                  d3.selectAll(".btn").on("mouseout", function(){
                    var isPreview = false;
                    if(!$(this).hasClass("currentFlag"))                    
                      clustering(title,isPreview);
                  });
                });
              </script>

            </body>
            </html>